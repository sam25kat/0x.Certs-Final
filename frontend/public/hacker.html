<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hacker Dashboard - Hackathon Certificate DApp</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .content {
            padding: 40px;
        }

        .wallet-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .wallet-info {
            display: none;
            padding: 10px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            margin-top: 10px;
            word-break: break-all;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        input[type="email"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="email"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            margin-bottom: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status.loading {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .events-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .events-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .event-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .event-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .event-code {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .event-details {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .event-meta {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>üíª Hacker Dashboard</h1>
                <p>Register for hackathons and receive your NFT certificates</p>
            </div>
            <a href="index.html" class="back-btn">‚Üê Back to Home</a>
        </div>
        
        <div class="content">
            <!-- Wallet Connection -->
            <div class="wallet-section">
                <button id="connectWallet" class="btn">Connect Wallet</button>
                <div id="walletInfo" class="wallet-info"></div>
                <button id="testWallet" class="btn btn-secondary" style="margin-top: 10px; background: #6c757d;">Test Wallet Connection</button>
            </div>

            <!-- Registration Form -->
            <h2>üìù Register for Event</h2>
            <form id="registrationForm">
                <div class="form-group">
                    <label for="eventCode">Event Code (6 digits)</label>
                    <input type="text" id="eventCode" placeholder="Enter 6-digit event code" maxlength="6" required>
                </div>
                
                <div class="form-group">
                    <label for="participantName">Full Name</label>
                    <input type="text" id="participantName" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label for="participantEmail">Email Address</label>
                    <input type="email" id="participantEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="teamName">Team Name (Optional)</label>
                    <input type="text" id="teamName" placeholder="Enter your team name">
                </div>
                
                <button type="submit" id="registerBtn" class="btn" disabled>Register & Mint PoA NFT</button>
            </form>
            
            <div id="status" class="status"></div>

            <!-- My NFT Status -->
            <div class="events-section" id="myNFTStatus" style="display: none;">
                <h3>üéñÔ∏è My NFT Status</h3>
                <div id="nftStatusContent">
                    <p>Loading your NFT status from blockchain...</p>
                </div>
            </div>

            <!-- Instructions -->
            <div class="events-section">
                <h3>üìã Instructions</h3>
                <p style="color: #666; line-height: 1.6;">
                    üîë <strong>Get your event code from the hackathon organizer</strong><br>
                    üìß You'll receive your certificate NFT via email after the event ends<br>
                    üéØ Each participant can only register once per event
                </p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        
        const CONTRACT_ABI = [
            {
                "inputs": [{"internalType": "address", "name": "recipient", "type": "address"}, {"internalType": "uint256", "name": "eventId", "type": "uint256"}],
                "name": "mintPoA",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];
        
        let userWallet = null;
        let provider = null;
        let CONTRACT_ADDRESS = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ DApp initializing...');
            
            // Check if ethers is loaded
            if (typeof ethers === 'undefined') {
                console.error('‚ùå Ethers.js not loaded');
                showStatus('error', 'Ethers.js library failed to load. Please refresh the page.');
                return;
            }
            console.log('‚úÖ Ethers.js loaded:', ethers.version);
            
            // Check if MetaMask is installed
            if (typeof window.ethereum === 'undefined') {
                console.error('‚ùå MetaMask not found');
                showStatus('error', 'MetaMask is not installed. Please install MetaMask to use this DApp.');
                return;
            }
            console.log('‚úÖ MetaMask detected');
            
            // Load configuration
            try {
                console.log('üîß Loading configuration...');
                const configResponse = await fetch(`${API_BASE}/config`);
                
                if (configResponse.ok) {
                    const config = await configResponse.json();
                    CONTRACT_ADDRESS = config.contract_address;
                    console.log('‚úÖ Contract address loaded from backend:', CONTRACT_ADDRESS);
                } else {
                    // Fallback to hardcoded address if backend config fails
                    console.warn('‚ö†Ô∏è Backend config failed, using fallback contract address');
                    CONTRACT_ADDRESS = '0x5FbDB2315678afecb367f032d93F642f64180aa3'; // Updated contract deployment
                    console.log('üìç Using fallback contract address:', CONTRACT_ADDRESS);
                }
                
                if (!CONTRACT_ADDRESS || CONTRACT_ADDRESS === 'your_deployed_contract_address_here') {
                    console.warn('‚ö†Ô∏è Contract address not set, wallet connection will still work');
                    // Don't return, let wallet connection work
                }
                
            } catch (error) {
                console.error('‚ùå Failed to load config:', error);
                // Still continue with fallback
                CONTRACT_ADDRESS = '0x5FbDB2315678afecb367f032d93F642f64180aa3';
                console.log('üìç Using hardcoded fallback:', CONTRACT_ADDRESS);
            }
            
            // Add event listeners
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('testWallet').addEventListener('click', testWallet);
            document.getElementById('registrationForm').addEventListener('submit', registerParticipant);
            
            // Auto-connect if previously connected
            checkConnection();
        });
        
        async function checkConnection() {
            try {
                if (window.ethereum && window.ethereum.selectedAddress) {
                    await connectWallet();
                }
            } catch (error) {
                console.log('No previous connection found');
            }
        }
        
        async function testWallet() {
            console.log('üß™ Testing wallet connection...');
            console.log('window.ethereum:', !!window.ethereum);
            console.log('ethers:', !!ethers);
            console.log('CONTRACT_ADDRESS:', CONTRACT_ADDRESS);
            
            try {
                if (window.ethereum) {
                    console.log('üîç Requesting accounts...');
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    console.log('Current accounts:', accounts);
                    
                    if (accounts.length > 0) {
                        console.log('‚úÖ Already connected to:', accounts[0]);
                        showStatus('success', `Already connected to: ${accounts[0]}`);
                    } else {
                        console.log('‚ö†Ô∏è No accounts connected');
                        showStatus('error', 'No accounts connected. Click "Connect Wallet" first.');
                    }
                } else {
                    console.log('‚ùå No ethereum provider');
                    showStatus('error', 'No ethereum provider found');
                }
            } catch (error) {
                console.error('Test wallet error:', error);
                showStatus('error', 'Test wallet error: ' + error.message);
            }
        }
        
        async function connectWallet() {
            try {
                showStatus('loading', 'Connecting to wallet...');
                console.log('Attempting to connect wallet...');
                
                // Check if MetaMask is available
                if (!window.ethereum) {
                    throw new Error('MetaMask not found');
                }
                
                // Request account access
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                if (accounts.length === 0) {
                    throw new Error('No accounts found');
                }
                
                userWallet = accounts[0];
                console.log('Wallet connected:', userWallet);
                
                // Initialize provider
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // Check network
                const network = await provider.getNetwork();
                console.log('Current network:', network);
                
                // Switch to localhost if needed
                if (network.chainId !== 31337) {
                    console.log('Switching to localhost network...');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x7a69' }], // 31337 in hex
                        });
                        console.log('Network switched successfully');
                    } catch (switchError) {
                        console.log('Switch error:', switchError);
                        if (switchError.code === 4902) {
                            console.log('Adding localhost network...');
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x7a69',
                                    chainName: 'Hardhat Localhost',
                                    rpcUrls: ['http://127.0.0.1:8545'],
                                    nativeCurrency: {
                                        name: 'ETH',
                                        symbol: 'ETH',
                                        decimals: 18
                                    }
                                }]
                            });
                            console.log('Network added successfully');
                        } else {
                            console.warn('Could not switch network:', switchError.message);
                            showStatus('error', '‚ö†Ô∏è Please manually switch to Hardhat Localhost network in MetaMask');
                            return;
                        }
                    }
                }
                
                // Update UI
                document.getElementById('connectWallet').textContent = 'Wallet Connected ‚úÖ';
                document.getElementById('connectWallet').disabled = true;
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('walletInfo').textContent = `Connected: ${userWallet.substring(0, 6)}...${userWallet.slice(-4)}`;
                document.getElementById('registerBtn').disabled = false;
                
                // Load user's NFT status
                await loadMyNFTStatus();
                
                hideStatus();
                console.log('Wallet connection completed successfully');
                
            } catch (error) {
                console.error('Error connecting wallet:', error);
                
                let errorMessage = 'Failed to connect wallet: ' + error.message;
                
                if (error.code === 4001) {
                    errorMessage = '‚ùå Connection rejected by user. Please try again and approve the connection.';
                } else if (error.code === -32002) {
                    errorMessage = '‚è≥ MetaMask is already processing a request. Please check MetaMask and try again.';
                }
                
                showStatus('error', errorMessage);
            }
        }
        
        async function mintPoANFT(eventId, eventName) {
            try {
                if (!CONTRACT_ADDRESS) {
                    showStatus('error', '‚ùå Contract address not loaded. Please refresh the page.');
                    return;
                }
                
                showStatus('loading', 'ü™ô Minting PoA NFT... Please confirm transaction in MetaMask');
                
                const signer = provider.getSigner();
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                console.log('Minting PoA for:', userWallet, 'Event ID:', eventId);
                
                // Test contract connection first
                try {
                    await provider.getNetwork();
                    console.log('‚úÖ Network connection OK');
                } catch (networkError) {
                    throw new Error('Network connection failed. Is Hardhat node running?');
                }
                
                // Send transaction
                console.log('üì§ Sending mintPoA transaction...');
                const tx = await contract.mintPoA(userWallet, eventId);
                
                showStatus('loading', `‚è≥ Transaction sent! Waiting for confirmation...\nTX Hash: ${tx.hash}`);
                
                // Wait for transaction to be mined
                const receipt = await tx.wait();
                
                console.log('Transaction successful:', receipt);
                
                // Confirm with backend
                await fetch(`${API_BASE}/confirm_poa_mint`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        wallet_address: userWallet,
                        event_id: eventId,
                        tx_hash: tx.hash
                    })
                });
                
                showStatus('success', `‚úÖ PoA NFT minted successfully for "${eventName}"!\n\nüîó Transaction Hash: ${tx.hash}\n\nüìß You'll receive your certificate NFT via email after the event ends.`);
                
                // Reset form
                document.getElementById('registrationForm').reset();
                document.getElementById('connectWallet').disabled = false;
                document.getElementById('connectWallet').textContent = 'Connect Wallet';
                document.getElementById('walletInfo').style.display = 'none';
                userWallet = null;
                document.getElementById('registerBtn').disabled = true;
                
            } catch (error) {
                console.error('NFT minting error:', error);
                
                let errorMessage = '';
                
                if (error.code === 4001) {
                    errorMessage = '‚ùå Transaction rejected by user. Please try again if you want to mint the PoA NFT.';
                } else if (error.message.includes('Network connection failed')) {
                    errorMessage = '‚ùå Network connection failed.\n\nPlease make sure:\n1. Hardhat node is running: cd blockchain && npx hardhat node\n2. Contract is deployed: cd blockchain && npx hardhat run scripts/deploy.js --network localhost';
                } else if (error.message.includes('Internal JSON-RPC error')) {
                    errorMessage = '‚ùå Blockchain connection error.\n\nTroubleshooting:\n1. Check if Hardhat node is running\n2. Make sure you\'re on localhost network in MetaMask\n3. Try refreshing the page';
                } else if (error.reason) {
                    errorMessage = `‚ùå Smart contract error: ${error.reason}`;
                } else {
                    errorMessage = `‚ùå NFT minting failed: ${error.message}`;
                }
                
                showStatus('error', errorMessage);
            }
        }

        async function registerParticipant(event) {
            event.preventDefault();
            
            if (!userWallet) {
                showStatus('error', 'Please connect your wallet first');
                return;
            }
            
            const formData = {
                wallet_address: userWallet,
                email: document.getElementById('participantEmail').value,
                name: document.getElementById('participantName').value,
                team_name: document.getElementById('teamName').value || '',
                event_code: document.getElementById('eventCode').value
            };
            
            try {
                showStatus('loading', 'üìù Registering participant...');
                
                const response = await fetch(`${API_BASE}/register_participant`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    if (result.requires_nft_mint) {
                        // Registration successful, now mint NFT
                        showStatus('success', `‚úÖ Registration successful for "${result.event_name}"!\n\nü™ô Now minting your PoA NFT...`);
                        await mintPoANFT(result.event_id, result.event_name);
                    } else {
                        showStatus('success', `‚úÖ Registration successful for "${result.event_name}"!`);
                        document.getElementById('registrationForm').reset();
                    }
                } else {
                    if (response.status === 400 && result.detail.includes('Already registered')) {
                        showStatus('error', `‚ö†Ô∏è ${result.detail}\n\nIf you believe this is an error, please contact support or try with a different wallet address.`);
                    } else if (response.status === 404) {
                        showStatus('error', `‚ùå ${result.detail}\n\nPlease check the event code with your organizer.`);
                    } else {
                        showStatus('error', `‚ùå ${result.detail || 'Registration failed'}\n\nPlease try again or contact support.`);
                    }
                }
                
            } catch (error) {
                console.error('Registration error:', error);
                showStatus('error', 'Registration failed: ' + error.message);
            }
        }

        async function loadMyNFTStatus() {
            if (!userWallet) return;
            
            try {
                console.log('üîç Loading NFT status for:', userWallet);
                const response = await fetch(`${API_BASE}/participant_status/${userWallet}`);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('NFT Status:', result);
                    
                    if (result.error) {
                        document.getElementById('nftStatusContent').innerHTML = 
                            `<p style="color: #dc3545;">‚ùå Error loading NFT status: ${result.error}</p>`;
                    } else if (Object.keys(result.events).length === 0) {
                        document.getElementById('nftStatusContent').innerHTML = 
                            '<p>No NFTs found for your wallet address.</p>';
                    } else {
                        // Display NFT status for each event
                        let statusHTML = '<div style="display: grid; gap: 15px;">';
                        
                        // Get event details for each event ID
                        for (const [eventId, nftStatus] of Object.entries(result.events)) {
                            statusHTML += `
                                <div style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <strong>Event ID: ${eventId}</strong>
                                        <div style="display: flex; gap: 10px;">
                                            ${nftStatus.poa_minted ? 
                                                `<span style="background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">‚úÖ PoA #${nftStatus.poa_token_id}</span>` : 
                                                '<span style="background: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">‚è≥ No PoA</span>'
                                            }
                                            ${nftStatus.certificate_minted ? 
                                                `<span style="background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">üèÜ Cert #${nftStatus.certificate_token_id}</span>` : 
                                                '<span style="background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">‚è≥ No Certificate</span>'
                                            }
                                        </div>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #666;">
                                        üìä <strong>Source:</strong> Blockchain Data (Real-time)
                                    </div>
                                </div>
                            `;
                        }
                        
                        statusHTML += '</div>';
                        document.getElementById('nftStatusContent').innerHTML = statusHTML;
                        document.getElementById('myNFTStatus').style.display = 'block';
                    }
                } else {
                    document.getElementById('nftStatusContent').innerHTML = 
                        '<p style="color: #dc3545;">‚ùå Failed to load NFT status from blockchain</p>';
                }
                
            } catch (error) {
                console.error('Error loading NFT status:', error);
                document.getElementById('nftStatusContent').innerHTML = 
                    `<p style="color: #dc3545;">‚ùå Error: ${error.message}</p>`;
            }
        }

        // Removed loadAvailableEvents function - hackers shouldn't see all events
        
        function showStatus(type, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'loading') {
                statusDiv.innerHTML = `<span class="loading-spinner"></span>${message}`;
            } else {
                statusDiv.textContent = message;
            }
        }
        
        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }
    </script>
</body>
</html>