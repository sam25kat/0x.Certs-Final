<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mint Your PoA NFT</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        .btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.loading {
            background: #d1ecf1;
            color: #0c5460;
        }
        .form-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéñÔ∏è Mint Your PoA NFT</h1>
        <p><strong>For participants who registered but didn't mint their PoA NFT yet.</strong></p>
        
        <div class="form-group">
            <label>Your Wallet Address</label>
            <input type="text" id="walletAddress" placeholder="Will auto-fill when connected" readonly>
        </div>
        
        <div class="form-group">
            <label>Event ID</label>
            <input type="number" id="eventId" placeholder="Enter Event ID (e.g., 1234)">
        </div>
        
        <button id="connectWallet" class="btn">Connect Wallet</button>
        <button id="mintPoA" class="btn" disabled>Mint PoA NFT</button>
        
        <div id="status" class="status"></div>
        
        <div style="margin-top: 30px; padding: 15px; background: #e3f2fd; border-radius: 5px;">
            <h3>üìã How to find your Event ID:</h3>
            <p>1. Go to <strong>organizer.html</strong></p>
            <p>2. Look at the events list</p>
            <p>3. Find your event and note the <strong>Event ID</strong> number</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        const CONTRACT_ADDRESS = '0x5fbdb2315678afecb367f032d93f642f64180aa3'; // Latest deployment
        
        const CONTRACT_ABI = [
            {
                "inputs": [{"internalType": "address", "name": "recipient", "type": "address"}, {"internalType": "uint256", "name": "eventId", "type": "uint256"}],
                "name": "mintPoA",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];
        
        let provider = null;
        let userWallet = null;
        
        function showStatus(type, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = message.replace(/\n/g, '<br>');
        }
        
        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }
        
        async function connectWallet() {
            try {
                showStatus('loading', 'Connecting to wallet...');
                
                if (!window.ethereum) {
                    throw new Error('MetaMask not found');
                }
                
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                userWallet = accounts[0];
                document.getElementById('walletAddress').value = userWallet;
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // Check network
                const network = await provider.getNetwork();
                if (network.chainId !== 31337) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x7a69' }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x7a69',
                                    chainName: 'Hardhat Localhost',
                                    rpcUrls: ['http://127.0.0.1:8545'],
                                    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 }
                                }]
                            });
                        }
                    }
                }
                
                document.getElementById('connectWallet').textContent = 'Wallet Connected ‚úÖ';
                document.getElementById('connectWallet').disabled = true;
                document.getElementById('mintPoA').disabled = false;
                
                showStatus('success', `Connected to: ${userWallet}`);
                
            } catch (error) {
                console.error('Connection error:', error);
                showStatus('error', 'Failed to connect wallet: ' + error.message);
            }
        }
        
        async function mintPoA() {
            try {
                const eventId = document.getElementById('eventId').value;
                if (!eventId) {
                    showStatus('error', 'Please enter an Event ID');
                    return;
                }
                
                if (!userWallet) {
                    showStatus('error', 'Please connect wallet first');
                    return;
                }
                
                showStatus('loading', 'ü™ô Minting PoA NFT... Please confirm transaction in MetaMask');
                
                const signer = provider.getSigner();
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                console.log('Minting PoA for:', userWallet, 'Event ID:', eventId);
                
                // Send transaction
                const tx = await contract.mintPoA(userWallet, parseInt(eventId));
                
                showStatus('loading', `‚è≥ Transaction sent! Waiting for confirmation...\nTX Hash: ${tx.hash}`);
                
                // Wait for transaction to be mined
                const receipt = await tx.wait();
                
                console.log('Transaction successful:', receipt);
                
                // Update backend
                try {
                    await fetch(`${API_BASE}/confirm_poa_mint`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            wallet_address: userWallet,
                            event_id: parseInt(eventId),
                            tx_hash: tx.hash
                        })
                    });
                } catch (e) {
                    console.warn('Backend update failed:', e);
                }
                
                showStatus('success', `‚úÖ PoA NFT minted successfully!\n\nüîó Transaction Hash: ${tx.hash}\n\nüéâ You can now view your NFT in the organizer dashboard!`);
                
            } catch (error) {
                console.error('Minting error:', error);
                
                if (error.code === 4001) {
                    showStatus('error', '‚ùå Transaction rejected by user');
                } else if (error.message.includes('Already registered')) {
                    showStatus('error', '‚úÖ You already have a PoA NFT for this event!');
                } else {
                    showStatus('error', `‚ùå Minting failed: ${error.reason || error.message}`);
                }
            }
        }
        
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('mintPoA').addEventListener('click', mintPoA);
        
        console.log('üéñÔ∏è PoA NFT Minting page loaded');
    </script>
</body>
</html>